---
title: "Results Summary: Rodriguez Augmentation Methods"
author: ""
date: today
format:
  html:
    toc: true
    number-sections: true
    theme: cosmo
    code-fold: true
    embed-resources: true
  gfm:
    toc: true
    number-sections: true
    code-fold: true
execute:
  echo: true
  warning: false
  message: false
editor: visual
---

```{r}
#| label: setup
#| include: false
library(here)
library(purrr)
library(dplyr)
library(tidyr)
library(stringr)

source(file.path(here::here(), "R", "summary_Rodriguez_helpers.R"))

# Read in aggregated results from Rodriguez augmentation methods
data_dir <- here::here("results", "results_aggregated")
rod_files <- list.files(
    data_dir,
    pattern = "^rodriguez.*_pc_half$",
    full.names = TRUE
)

rod_names <- rod_files |>
    basename() |>
    str_remove("^rodriguez_")

rod_data <- map(rod_files, readRDS)

walk2(rod_data, rod_names, ~ assign(.y, .x, envir = .GlobalEnv))
rm(rod_data)

# Read in benchmark models
benchmark_files <- list.files(
    data_dir,
    pattern = "^benchmark.*_pc_half$",
    full.names = TRUE
)

benchmark_names <- benchmark_files |>
    basename()

benchmark_data <- map(benchmark_files, readRDS)

walk2(benchmark_data, benchmark_names, ~ assign(.y, .x, envir = .GlobalEnv))
rm(benchmark_data)
```

## Interactive Summary Table - pseudo-count $1/2$

Use the controls to explore how Rodriguez augmentation strategies compare with their benchmarks in terms of the mean performance metric. You can choose among three performance metrics and four augmentation factors. Results are shown for experiments using data with a **pseudo-count of** $\mathbf{1/2}$.

```{r}
#| label: rodriguez-dashboard
#| echo: false

library(crosstalk)
library(DT)
library(htmltools)
library(kableExtra)

lasso_summary_wide <- build_summary_dataset(
    benchmark = benchmark_lasso_pc_half,
    aug_results = lasso_pc_half
)

lasso_summary_formatted <- format_summary_table(
    lasso_summary_wide,
    digits = 3,
    format = "html"
)

name_map <- c(
    "Augmentation factor" = "augmentation_factor",
    "Metric" = ".metric",
    "Dataset" = "data_id",
    "Proportion" = "proportion",
    "Standard ILR" = "standard_ilr",
    "Aitchison Mixup" = "aitchison_mixup",
    "Comp. Cutmix" = "comp_cutmix",
    "Comp. Feature Dropout" = "comp_feature"
)

lasso_summary_formatted <- lasso_summary_formatted |>
    rename(!!!name_map) |>
    mutate(
        `Augmentation factor` = factor(`Augmentation factor`, levels = sort(unique(`Augmentation factor`))),
        Metric = factor(Metric, levels = sort(unique(Metric))),
        Dataset = as.integer(Dataset)
    ) |>
    arrange(`Augmentation factor`, Metric, Dataset) |>
    select(
        `Augmentation factor`,
        Metric,
        Dataset,
        `Proportion`,
        `Standard ILR`,
        `Aitchison Mixup`,
        `Comp. Cutmix`,
        `Comp. Feature Dropout`
    )

table_container <- htmltools::withTags(table(
    class = "display",
    thead(
        tr(
            th(rowspan = 2, "Augmentation factor"),
            th(rowspan = 2, "Metric"),
            th(rowspan = 2, "Dataset"),
            th(colspan = 2, "Benchmark"),
            th(rowspan = 2, "Aitchison Mixup"),
            th(rowspan = 2, "Comp. Cutmix"),
            th(rowspan = 2, "Comp. Feature Dropout")
        ),
        tr(
            th("Proportion"),
            th("Standard ILR")
        )
    )
))

shared_lasso <- SharedData$new(
    lasso_summary_formatted,
    key = ~ paste(Metric, `Augmentation factor`, Dataset)
)

controls <- bscols(
    widths = c(6, 6),
    filter_select("metric_filter", "Performance metric", shared_lasso, ~Metric),
    filter_select("factor_filter", "Augmentation factor", shared_lasso, ~`Augmentation factor`)
)

browsable(tagList(
    controls,
    datatable(
        shared_lasso,
        escape = FALSE,
        rownames = FALSE,
        container = table_container,
        options = list(
            dom = "tip",
            pageLength = 12,
            ordering = FALSE,
            autoWidth = TRUE
        )
    )
))
```

```{r}
#| label: save-rodriguez-latex
#| echo: false

output_dir <- here::here("quarto_scripts", "tables")
metric <- "roc_auc"
model_name <- "lasso"
aug_factors <- sort(unique(lasso_pc_half$augmentation_factor))

for (aug_factor in aug_factors) {
    caption <- sprintf(
        "Mean ROC AUC of LASSO Rodriguez augmentations (augmentation factor = %s)",
        aug_factor
    )
    table_name <- sprintf("rodriguez_%s_mean_%s_%s", model_name, metric, aug_factor)
    save_metric_table_latex(
        benchmark = benchmark_lasso_pc_half,
        aug_results = lasso_pc_half,
        aug_factor = aug_factor,
        perf_metric = metric,
        model = model_name,
        table_caption = caption,
        table_name = table_name,
        output_dir = output_dir
    )
}
```

##